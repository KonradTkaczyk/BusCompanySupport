<% content_for :javascript_includes do %>
  <%= javascript_include_tag "OpenLayers.js" %>
  <%= javascript_include_tag "IndexMap.js" %>
<% end %>

    <div id="map"></div>
    <br />


<table id="FoundTickets">
  <tr>
    <th><%= sortable "cityFrom" %></th>
    <th><%= sortable "cityTo" %></th>
    <th><%= sortable "dateOfTrip" %></th>
    <th><%= sortable "endOfTrip" %></th>
    <th><%= sortable "bus_id" %></th>
    <th></th>
    <th></th>
    <th></th>
    <th></th>
  </tr>
  <% seats = [1,2,3,4,5,6,7,8,9,10] %>
  <% i = 0 %>
<% tripTickets = Array.new %> <!-- array of free seats -->
<% @tickets.each_cons(2) do |ticket,ticket2| %>
  <% if ticket.trip != ticket2.trip || ticket2.nil?%>
    <tr>
      <td><%= ticket.cityFrom %></td>
      <td><%= ticket.cityTo %></td>
      <td><%= ticket.dateOfTrip.strftime("%A %d-%m-%Y %H:%M") %></td>
      <td><%= ticket.endOfTrip.strftime("%A %d-%m-%Y %H:%M") %></td>
      <% if ticket.bus_id != nil %>
      <td><%= link_to Bus.find(ticket.bus_id).nameOfBus, bus_path(Bus.find(ticket.bus_id))  %></td>
      <% end %>
      <td><%= content_tag "div", id: "Seat", data:{seats: (seats-tripTickets),tripid:(ticket.trip)} do %> <!-- tag to hold seats that are already reserved -->
      <% end %></td>
      <% logger.debug(tripTickets)%>
      <td><div id="holder">
          <ul  id="place" class="place"> <!-- Place to put seats for reservation -->
          </ul>
      </div>
      <div style="float:left;">
      <ul id="seatDescription">
          <li style="background:url('/images/available_seat_img.gif') no-repeat scroll 0 0 transparent;">Available Seat</li>
          <li style="background:url('/images/reserved_seat_img.gif') no-repeat scroll 0 0 transparent;">Reserved Seat</li>
          <li style="background:url('/images/selected_seat_img.gif') no-repeat scroll 0 0 transparent;">Selected Seat</li>
      </ul>
      </div>
    </tr>
    <% tripTickets.clear %>
  <%elsif ticket.trip != ticket2.trip || ticket2 == @tickets.last%>
  <%tripTickets.push(ticket2.nameOfSeat.to_i)%>
  <tr>
      <td><%= ticket2.cityFrom %></td>
      <td><%= ticket2.cityTo %></td>
      <td><%= ticket2.dateOfTrip.strftime("%A %d-%m-%Y %H:%M") %></td>
      <td><%= ticket2.endOfTrip.strftime("%A %d-%m-%Y %H:%M") %></td>
      <% if ticket2.bus_id != nil %>
      <td><%= link_to Bus.find(ticket2.bus_id).nameOfBus, bus_path(Bus.find(ticket2.bus_id))  %></td>
      <% end %>
      <td><%= content_tag "div", id: "Seat", data:{seats: (seats-tripTickets),tripid:(ticket2.trip)} do %>
      <% end %></td>
      <% logger.debug(tripTickets)%>
      <td><div id="holder">
          <ul  id="place" class="place"> <!-- Place to put seats for reservation -->
          </ul>
      </div>
      <div style="float:left;">
      <ul id="seatDescription">
          <li style="background:url('/images/available_seat_img.gif') no-repeat scroll 0 0 transparent;">Available Seat</li>
          <li style="background:url('/images/reserved_seat_img.gif') no-repeat scroll 0 0 transparent;">Reserved Seat</li>
          <li style="background:url('/images/selected_seat_img.gif') no-repeat scroll 0 0 transparent;">Selected Seat</li>
      </ul>
      </div>
    </tr>
  <% end %>
  <% if ticket == @tickets[0] %>
    <% tripTickets.push(ticket.nameOfSeat.to_i) %>
  <% end %>
  <% tripTickets.push(ticket2.nameOfSeat.to_i) %>
  <% trip = ticket2.trip %>
<% end %>
</table>
<br />
<% if @tickets == nil %>
  Sorry no possible route have been found.
<% end %>
<input type="button" id="Reserve" value="Reserve selected seats" />
<%= link_to("Reserve seats", :url =>"/tickets/reserve", :method=>'get', :update =>'seats', :remote=>true) %>
<br />

